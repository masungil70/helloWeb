name: ë¬´ì¤‘ë‹¨ was ìš´ì˜ ë°©ë²•(Blue-Green ë°°í¬ ì „ëµ)
on: 
  push:
    branches: [ main ]

#í™˜ê²½ì„¤ì •ë³€ìˆ˜
env:
  REPOSITORY_NAME: hello-web:blue
  USER: /home/kosa
      
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: gradlew ì‹¤í–‰ê¶Œí•œ ì„¤ì • 
        run: chmod +x gradlew
        
      - name: test gradlew 
        run: ./gradlew --info test
        
      - name: build gradlew 
        run: ./gradlew bootJar
       
      - name: docker image build 
        run: |
          docker build -t ${{ secrets.USERNAME }}/${{env.REPOSITORY_NAME}} . 
        
      - name: docker hub login
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
        
      - name: docker hub push 
        run: docker push ${{ secrets.USERNAME }}/${{env.REPOSITORY_NAME}}
        
  deploy:
    needs: build
    name: ì„œë²„ì— ë°°í¬ ë‹¨ê³„
    runs-on: [ self-hosted, kosa-host ]
    steps:
    - name: ìš´ì˜ì„œë²„ì—ì„œ docker hubì— ë¡œê·¸ì¸ 
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWORD }}
    
    - name: docker-composeì—ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë° ì‹¤í–‰ 
      run: |
        cd ${{env.USER}}/helloWeb/docker  #ì‘ì—… ê²½ë¡œ ë³€ê²½
        
        ls -al docker-compose.yml  # ğŸ‘ˆ ë””ë²„ê¹…ìš©, íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
         
        #blue-green ì „ëµì— ë§ê²Œ ì‘ì—…ì„ ì§„í–‰í•œë‹¤
        echo "[1] ìƒˆ ì´ë¯¸ì§€ë¥¼ docker hubë¡œ ë¶€í„° pull ë‚´ë ¤ ë°›ëŠ”ë‹¤"
        docker pull masungil/hello-web:blue

        echo "[2] Blue ì»¨í…Œì´ë„ˆ ì‹œì‘"
        docker compose  up -d was1-blue was2-blue

        echo "[3] Blue ì»¨í…Œì´ë„ˆ Health Check ìˆ˜í–‰..."
        sleep 3
        curl --fail http://localhost:8080 || {
                echo "Blue ì»¨í…Œì´ë„ˆ Health check ì‹¤íŒ¨. ë¡¤ë°±í•©ë‹ˆë‹¤."
                exit 1
        }

        echo "[4] Blue  greenìœ¼ë¡œ ë³€ê²½"
        cp nginx-blue.conf nginx.conf
        docker exec webserver nginx -s reload

        echo "[5] blue ì´ë¯¸ì§€ë¥¼ greenìœ¼ë¡œ ì´ë¯¸ì§€ë¡œ tag"
        docker tag masungil/hello-web:blue  masungil/hello-web:green

        echo "[6] greenë¥¼ docker hubì— push í•œë‹¤"
        docker push masungil/hello-web:green

        echo "[7] í˜„ì¬ ì‹¤í–‰ì¤‘ì´ docker comspose greenë¥¼ ìƒˆë¡œìš´ green ì´ë¯¸ì§€ë¡œ ë°˜ì˜í•œë‹¤"
        docker compose up -d was1-green was2-green

        echo "[8] í˜„ì¬ ì‹¤í–‰ì¤‘ì´ blue ì‹¤í–‰ í™˜ê²½ì„ green í™˜ê²½ ë³€ê²½í•œë‹¤"
        cp nginx-green.conf nginx.conf
        docker exec webserver nginx -s reload

        echo "[9] ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€/ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
        docker image prune -f

        echo "[10] ë°°í¬ ì™„ë£Œ"
